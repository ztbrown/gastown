<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gas Town Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
    <div class="dashboard" id="dashboard-main" hx-get="/" hx-trigger="every 10s [!window.pauseRefresh]" hx-swap="outerHTML">
        <header>
            <h1>üöö Gas Town Control Center</h1>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="cmd-btn" id="open-palette-btn">
                    <span>‚åò</span> Commands <kbd>‚åòK</kbd>
                </button>
                <span class="refresh-info">
                    Auto-refresh: 10s
                    <span class="htmx-indicator">‚ü≥</span>
                </span>
            </div>
        </header>

        <!-- Mayor Status Banner -->
        <div class="mayor-banner {{if .Mayor}}{{if .Mayor.IsAttached}}attached{{else}}detached{{end}}{{else}}detached{{end}}">
            <div class="mayor-info">
                <span class="mayor-icon">üé©</span>
                <span class="mayor-title">The Mayor</span>
                {{if .Mayor}}
                    {{if .Mayor.IsAttached}}
                    <span class="badge badge-green">Attached</span>
                    {{else}}
                    <span class="badge badge-muted">Detached</span>
                    {{end}}
                {{else}}
                <span class="badge badge-muted">Unknown</span>
                {{end}}
            </div>
            {{if .Mayor}}{{if .Mayor.IsAttached}}
            <div class="mayor-status">
                <div class="mayor-stat">
                    <span class="mayor-stat-label">Activity</span>
                    <span class="mayor-stat-value {{if .Mayor.IsActive}}active{{else}}idle{{end}}">
                        {{.Mayor.LastActivity}}
                    </span>
                </div>
                <div class="mayor-stat">
                    <span class="mayor-stat-label">Runtime</span>
                    <span class="mayor-stat-value">{{.Mayor.Runtime}}</span>
                </div>
            </div>
            {{end}}{{end}}
        </div>

        <!-- Summary & Alerts Banner -->
        {{if .Summary}}
        <div class="summary-banner">
            <div class="summary-stats">
                <div class="stat">
                    <span class="stat-value">{{.Summary.PolecatCount}}</span>
                    <span class="stat-label">ü¶® Polecats</span>
                </div>
                <div class="stat">
                    <span class="stat-value">{{.Summary.HookCount}}</span>
                    <span class="stat-label">ü™ù Hooks</span>
                </div>
                <div class="stat">
                    <span class="stat-value">{{.Summary.IssueCount}}</span>
                    <span class="stat-label">üìø Issues</span>
                </div>
                <div class="stat">
                    <span class="stat-value">{{.Summary.ConvoyCount}}</span>
                    <span class="stat-label">üöö Convoys</span>
                </div>
                <div class="stat">
                    <span class="stat-value">{{.Summary.EscalationCount}}</span>
                    <span class="stat-label">‚ö†Ô∏è Escalations</span>
                </div>
            </div>
            {{if .Summary.HasAlerts}}
            <div class="summary-alerts">
                {{if .Summary.StuckPolecats}}
                <span class="alert-item alert-red">üíÄ {{.Summary.StuckPolecats}} stuck</span>
                {{end}}
                {{if .Summary.StaleHooks}}
                <span class="alert-item alert-yellow">‚è∞ {{.Summary.StaleHooks}} stale hooks</span>
                {{end}}
                {{if .Summary.UnackedEscalations}}
                <span class="alert-item alert-orange">üîî {{.Summary.UnackedEscalations}} unacked</span>
                {{end}}
                {{if .Summary.HighPriorityIssues}}
                <span class="alert-item alert-red">üî• {{.Summary.HighPriorityIssues}} P1/P2</span>
                {{end}}
                {{if .Summary.DeadSessions}}
                <span class="alert-item alert-red">‚ò†Ô∏è {{.Summary.DeadSessions}} dead</span>
                {{end}}
            </div>
            {{else}}
            <div class="summary-alerts">
                <span class="alert-item alert-green">‚úì All clear</span>
            </div>
            {{end}}
        </div>
        {{end}}

        <div class="panels">
            <!-- Row 1: Convoys, Polecats, Sessions -->

            <!-- Convoys Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üöö Convoys</h2>
                    <span class="count">{{len .Convoys}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Convoys}}
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Convoy</th>
                                <th>Progress</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Convoys}}
                            <tr class="convoy-row">
                                <td>
                                    {{if eq .WorkStatus "complete"}}
                                    <span class="badge badge-green">‚úì</span>
                                    {{else if eq .WorkStatus "active"}}
                                    <span class="badge badge-green">Active</span>
                                    {{else if eq .WorkStatus "stale"}}
                                    <span class="badge badge-yellow">Stale</span>
                                    {{else if eq .WorkStatus "stuck"}}
                                    <span class="badge badge-red">Stuck</span>
                                    {{else}}
                                    <span class="badge badge-muted">Wait</span>
                                    {{end}}
                                </td>
                                <td>
                                    <span class="convoy-id">{{.ID}}</span>
                                </td>
                                <td>
                                    {{.Progress}}
                                    {{if .Total}}
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{progressPercent .Completed .Total}}%;"></div>
                                    </div>
                                    {{end}}
                                </td>
                                <td class="{{activityClass .LastActivity}}">
                                    <span class="activity-dot"></span>
                                    {{.LastActivity.FormattedAge}}
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="empty-state">
                        <p>No active convoys</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Workers Panel (Polecats + Refinery) -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üë∑ Workers</h2>
                    <span class="count">{{len .Workers}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Workers}}
                    <table>
                        <thead>
                            <tr>
                                <th>Worker</th>
                                <th>Type</th>
                                <th>Rig</th>
                                <th>Working On</th>
                                <th>Status</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Workers}}
                            <tr class="{{polecatStatusClass .WorkStatus}}">
                                <td><span class="polecat-name">{{.Name}}</span></td>
                                <td>
                                    {{if eq .AgentType "refinery"}}
                                    <span class="badge badge-blue">refinery</span>
                                    {{else}}
                                    <span class="badge badge-muted">polecat</span>
                                    {{end}}
                                </td>
                                <td><span class="polecat-rig">{{.Rig}}</span></td>
                                <td class="polecat-issue">
                                    {{if .IssueID}}
                                    <span class="issue-id">{{.IssueID}}</span>
                                    <span class="issue-title">{{.IssueTitle}}</span>
                                    {{else}}
                                    <span class="no-issue">‚Äî</span>
                                    {{end}}
                                </td>
                                <td>
                                    {{if eq .WorkStatus "working"}}
                                    <span class="badge badge-green">Working</span>
                                    {{else if eq .WorkStatus "stale"}}
                                    <span class="badge badge-yellow">Stale</span>
                                    {{else if eq .WorkStatus "stuck"}}
                                    <span class="badge badge-red">Stuck</span>
                                    {{else}}
                                    <span class="badge badge-muted">Idle</span>
                                    {{end}}
                                </td>
                                <td class="{{activityClass .LastActivity}}">
                                    <span class="activity-dot"></span>
                                    {{.LastActivity.FormattedAge}}
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="empty-state">
                        <p>No active workers</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Sessions Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üìü Sessions</h2>
                    <span class="count">{{len .Sessions}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Sessions}}
                    <table>
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Rig</th>
                                <th>Worker</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Sessions}}
                            <tr>
                                <td>
                                    <span class="role-{{.Role}}">{{.Role}}</span>
                                </td>
                                <td>{{.Rig}}</td>
                                <td>{{.Worker}}</td>
                                <td>{{.Activity}}</td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="empty-state">
                        <p>No active sessions</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Activity Feed Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üìú Activity</h2>
                    <span class="count">{{len .Activity}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body activity-feed">
                    {{if .Activity}}
                    <div class="feed-list">
                        {{range .Activity}}
                        <div class="feed-item">
                            <span class="feed-icon">{{.Icon}}</span>
                            <span class="feed-summary">{{.Summary}}</span>
                            <span class="feed-time">{{.Time}}</span>
                        </div>
                        {{end}}
                    </div>
                    {{else}}
                    <div class="empty-state">
                        <p>No recent activity</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Row 2: Mail, Merge Queue, Escalations -->

            <!-- Mail Panel -->
            <div class="panel" id="mail-panel">
                <div class="panel-header">
                    <h2>‚úâÔ∏è Mail</h2>
                    <span class="count" id="mail-count">{{len .Mail}}</span>
                    <div class="mail-tabs">
                        <button class="mail-tab active" data-tab="inbox">Inbox</button>
                        <button class="mail-tab" data-tab="all">All Traffic</button>
                    </div>
                    <button class="compose-btn" id="compose-mail-btn" title="Compose new message">‚úé</button>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    <!-- Inbox view (overseer inbox via API) -->
                    <div id="mail-list">
                        <div class="loading-state" id="mail-loading">Loading inbox...</div>
                        <table id="mail-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>Subject</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="mail-tbody">
                            </tbody>
                        </table>
                        <div class="empty-state" id="mail-empty" style="display: none;">
                            <p>No mail in inbox</p>
                        </div>
                    </div>
                    <!-- All Mail view (all traffic from beads) -->
                    <div id="mail-all" style="display: none;">
                        {{if .Mail}}
                        <table class="mail-all-table">
                            <thead>
                                <tr>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Subject</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .Mail}}
                                <tr class="mail-row {{if not .Read}}mail-unread{{end}}" data-msg-id="{{.ID}}" data-from="{{.FromRaw}}">
                                    <td class="mail-from">{{.From}}</td>
                                    <td class="mail-to">{{.To}}</td>
                                    <td>
                                        {{if eq .Priority "urgent"}}<span class="priority-urgent">‚ö°</span>{{end}}
                                        {{if eq .Priority "high"}}<span class="priority-high">!</span>{{end}}
                                        <span class="mail-subject">{{.Subject}}</span>
                                    </td>
                                    <td class="mail-time">{{.Age}}</td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                        {{else}}
                        <div class="empty-state">
                            <p>No mail traffic</p>
                        </div>
                        {{end}}
                    </div>
                    <!-- Message detail view (hidden by default) -->
                    <div id="mail-detail" class="mail-detail" style="display: none;">
                        <div class="mail-detail-header">
                            <button class="mail-back-btn" id="mail-back-btn">‚Üê Back</button>
                            <span class="mail-detail-subject" id="mail-detail-subject"></span>
                        </div>
                        <div class="mail-detail-meta">
                            <span class="mail-detail-from">From: <strong id="mail-detail-from"></strong></span>
                            <span class="mail-detail-time" id="mail-detail-time"></span>
                        </div>
                        <div class="mail-detail-body" id="mail-detail-body"></div>
                        <div class="mail-detail-actions">
                            <button class="mail-reply-btn" id="mail-reply-btn">‚Ü© Reply</button>
                        </div>
                    </div>
                    <!-- Compose form (hidden by default) -->
                    <div id="mail-compose" class="mail-compose" style="display: none;">
                        <div class="mail-compose-header">
                            <button class="mail-back-btn" id="compose-back-btn">‚Üê Back</button>
                            <span class="mail-compose-title" id="mail-compose-title">New Message</span>
                        </div>
                        <div class="mail-compose-form">
                            <div class="mail-compose-field">
                                <label for="compose-to">To:</label>
                                <select id="compose-to" class="mail-compose-input"></select>
                            </div>
                            <div class="mail-compose-field">
                                <label for="compose-subject">Subject:</label>
                                <input type="text" id="compose-subject" class="mail-compose-input" placeholder="Enter subject...">
                            </div>
                            <div class="mail-compose-field">
                                <label for="compose-body">Message:</label>
                                <textarea id="compose-body" class="mail-compose-textarea" placeholder="Enter message..." rows="4"></textarea>
                            </div>
                            <input type="hidden" id="compose-reply-to" value="">
                            <div class="mail-compose-actions">
                                <button class="mail-send-btn" id="mail-send-btn">Send</button>
                                <button class="mail-cancel-btn" id="compose-cancel-btn">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Merge Queue Panel -->
            <div class="panel" id="merge-queue-panel">
                <div class="panel-header">
                    <h2>üîÄ Merge Queue</h2>
                    <span class="count">{{len .MergeQueue}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    <!-- PR List View -->
                    <div id="pr-list">
                        {{if .MergeQueue}}
                        <table>
                            <thead>
                                <tr>
                                    <th>PR</th>
                                    <th>Repo</th>
                                    <th>Title</th>
                                    <th>CI</th>
                                    <th>Merge</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .MergeQueue}}
                                <tr class="pr-row {{.ColorClass}}" data-pr-url="{{.URL}}" data-pr-repo="{{.Repo}}" data-pr-number="{{.Number}}">
                                    <td><span class="pr-link">#{{.Number}}</span></td>
                                    <td>{{.Repo}}</td>
                                    <td class="pr-title">{{.Title}}</td>
                                    <td>
                                        {{if eq .CIStatus "pass"}}<span class="badge badge-green">CI Pass</span>
                                        {{else if eq .CIStatus "fail"}}<span class="badge badge-red">CI Fail</span>
                                        {{else}}<span class="badge badge-yellow">CI Running</span>{{end}}
                                    </td>
                                    <td>
                                        {{if eq .Mergeable "ready"}}<span class="badge badge-green">Ready</span>
                                        {{else if eq .Mergeable "conflict"}}<span class="badge badge-red">Conflict</span>
                                        {{else}}<span class="badge badge-muted">Pending</span>{{end}}
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                        {{else}}
                        <div class="empty-state">
                            <p>No PRs in queue</p>
                        </div>
                        {{end}}
                    </div>
                    <!-- PR Detail View (hidden by default) -->
                    <div id="pr-detail" style="display: none;">
                        <div class="detail-header">
                            <button id="pr-back-btn" class="btn-back">‚Üê Back</button>
                            <a id="pr-detail-link" href="#" target="_blank" class="btn-link">Open in GitHub ‚Üó</a>
                        </div>
                        <div class="pr-detail-content">
                            <div class="pr-detail-title">
                                <span id="pr-detail-state" class="pr-state"></span>
                                <span id="pr-detail-number" class="pr-number"></span>
                            </div>
                            <h3 id="pr-detail-title-text"></h3>
                            <div class="pr-detail-meta">
                                <span id="pr-detail-author"></span>
                                <span id="pr-detail-branches"></span>
                                <span id="pr-detail-created"></span>
                            </div>
                            <div class="pr-detail-stats">
                                <span id="pr-detail-additions" class="stat-additions"></span>
                                <span id="pr-detail-deletions" class="stat-deletions"></span>
                                <span id="pr-detail-files"></span>
                            </div>
                            <div class="pr-detail-section">
                                <h4>Description</h4>
                                <pre id="pr-detail-body"></pre>
                            </div>
                            <div id="pr-detail-labels-section" class="pr-detail-section" style="display: none;">
                                <h4>Labels</h4>
                                <div id="pr-detail-labels"></div>
                            </div>
                            <div id="pr-detail-checks-section" class="pr-detail-section" style="display: none;">
                                <h4>Checks</h4>
                                <div id="pr-detail-checks"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Escalations Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üö® Escalations</h2>
                    <span class="count{{if .Escalations}} count-alert{{end}}">{{len .Escalations}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Escalations}}
                    <table>
                        <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Issue</th>
                                <th>From</th>
                                <th>Age</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Escalations}}
                            <tr>
                                <td>
                                    {{if eq .Severity "critical"}}<span class="badge badge-red">CRIT</span>
                                    {{else if eq .Severity "high"}}<span class="badge badge-orange">HIGH</span>
                                    {{else if eq .Severity "medium"}}<span class="badge badge-yellow">MED</span>
                                    {{else}}<span class="badge badge-muted">LOW</span>{{end}}
                                </td>
                                <td>
                                    <span class="severity-{{.Severity}}">{{.Title}}</span>
                                    {{if .Acked}}<span class="badge badge-cyan" style="margin-left: 4px;">ACK</span>{{end}}
                                </td>
                                <td>{{.EscalatedBy}}</td>
                                <td>{{.Age}}</td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="empty-state">
                        <p>No escalations</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Row 3: Rigs, Dogs, Health -->

            <!-- Rigs Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üèóÔ∏è Rigs</h2>
                    <span class="count">{{len .Rigs}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Rigs}}
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Polecats</th>
                                <th>Crew</th>
                                <th>Agents</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Rigs}}
                            <tr>
                                <td><span class="rig-name">{{.Name}}</span></td>
                                <td>{{.PolecatCount}}</td>
                                <td>{{.CrewCount}}</td>
                                <td class="agent-icons">
                                    <span class="agent-icon{{if .HasWitness}} active{{end}}" title="Witness">üëÅ</span>
                                    <span class="agent-icon{{if .HasRefinery}} active{{end}}" title="Refinery">‚öóÔ∏è</span>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="empty-state">
                        <p>No rigs configured</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Dogs Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üêï Dogs</h2>
                    <span class="count">{{len .Dogs}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Dogs}}
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>State</th>
                                <th>Work</th>
                                <th>Activity</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Dogs}}
                            <tr>
                                <td><span class="polecat-name">{{.Name}}</span></td>
                                <td>
                                    {{if eq .State "idle"}}<span class="badge badge-green">Idle</span>
                                    {{else}}<span class="badge badge-yellow">Working</span>{{end}}
                                </td>
                                <td class="status-hint">{{.Work}}</td>
                                <td>{{.LastActive}}</td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="empty-state">
                        <p>No dogs in kennel</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Health Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>üíì System Health</h2>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Health}}
                    <div class="health-grid">
                        <div class="health-item">
                            <div class="health-label">Deacon Heartbeat</div>
                            <div class="health-value {{if .Health.HeartbeatFresh}}good{{else}}bad{{end}}">
                                {{.Health.DeaconHeartbeat}}
                            </div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">Cycle</div>
                            <div class="health-value">{{.Health.DeaconCycle}}</div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">Healthy Agents</div>
                            <div class="health-value good">{{.Health.HealthyAgents}}</div>
                        </div>
                        <div class="health-item">
                            <div class="health-label">Unhealthy</div>
                            <div class="health-value {{if .Health.UnhealthyAgents}}bad{{else}}good{{end}}">
                                {{.Health.UnhealthyAgents}}
                            </div>
                        </div>
                        {{if .Health.IsPaused}}
                        <div class="health-item" style="grid-column: 1 / -1; background: rgba(240, 113, 120, 0.1);">
                            <div class="health-label">‚ö†Ô∏è Deacon Paused</div>
                            <div class="health-value bad">{{.Health.PauseReason}}</div>
                        </div>
                        {{end}}
                    </div>
                    {{else}}
                    <div class="empty-state">
                        <p>Health data unavailable</p>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Queues Panel (optional, only show if there are queues) -->
            {{if .Queues}}
            <div class="panel">
                <div class="panel-header">
                    <h2>üìã Queues</h2>
                    <span class="count">{{len .Queues}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    <table>
                        <thead>
                            <tr>
                                <th>Queue</th>
                                <th>Status</th>
                                <th>Avail</th>
                                <th>Proc</th>
                                <th>Done</th>
                                <th>Fail</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Queues}}
                            <tr>
                                <td>{{.Name}}</td>
                                <td>
                                    {{if eq .Status "active"}}<span class="badge badge-green">Active</span>
                                    {{else if eq .Status "paused"}}<span class="badge badge-yellow">Paused</span>
                                    {{else}}<span class="badge badge-muted">Closed</span>{{end}}
                                </td>
                                <td>{{.Available}}</td>
                                <td>{{.Processing}}</td>
                                <td>{{.Completed}}</td>
                                <td>{{if .Failed}}<span class="severity-high">{{.Failed}}</span>{{else}}0{{end}}</td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
            {{end}}

            <!-- Open Issues Panel -->
            <div class="panel" id="issues-panel">
                <div class="panel-header">
                    <h2>üìø Open Issues</h2>
                    <span class="count">{{len .Issues}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    <!-- Issues List View -->
                    <div id="issues-list">
                        {{if .Issues}}
                        <table>
                            <thead>
                                <tr>
                                    <th>Pri</th>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Age</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range .Issues}}
                                <tr class="issue-row priority-{{.Priority}}" data-issue-id="{{.ID}}">
                                    <td>
                                        {{if eq .Priority 1}}<span class="badge badge-red">P1</span>
                                        {{else if eq .Priority 2}}<span class="badge badge-orange">P2</span>
                                        {{else if eq .Priority 3}}<span class="badge badge-yellow">P3</span>
                                        {{else}}<span class="badge badge-muted">P4</span>{{end}}
                                    </td>
                                    <td><span class="issue-id">{{.ID}}</span></td>
                                    <td class="issue-title">{{.Title}}</td>
                                    <td class="issue-type">{{.Type}}</td>
                                    <td>{{.Age}}</td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                        {{else}}
                        <div class="empty-state">
                            <p>No open issues</p>
                        </div>
                        {{end}}
                    </div>
                    <!-- Issue Detail View (hidden by default) -->
                    <div id="issue-detail" style="display: none;">
                        <div class="detail-header">
                            <button id="issue-back-btn" class="btn-back">‚Üê Back</button>
                        </div>
                        <div class="issue-detail-content">
                            <div class="issue-detail-title">
                                <span id="issue-detail-priority" class="badge"></span>
                                <span id="issue-detail-id" class="issue-id"></span>
                                <span id="issue-detail-status" class="issue-status"></span>
                            </div>
                            <h3 id="issue-detail-title-text"></h3>
                            <div class="issue-detail-meta">
                                <span id="issue-detail-type"></span>
                                <span id="issue-detail-created"></span>
                            </div>
                            <div class="issue-detail-section">
                                <h4>Description</h4>
                                <pre id="issue-detail-description"></pre>
                            </div>
                            <div id="issue-detail-deps" class="issue-detail-section" style="display: none;">
                                <h4>Dependencies</h4>
                                <div id="issue-detail-depends-on"></div>
                            </div>
                            <div id="issue-detail-blocks-section" class="issue-detail-section" style="display: none;">
                                <h4>Blocks</h4>
                                <div id="issue-detail-blocks"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hooks Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2>ü™ù Hooks</h2>
                    <span class="count{{if .Hooks}} {{end}}">{{len .Hooks}}</span>
                    <button class="expand-btn">Expand</button>
                </div>
                <div class="panel-body">
                    {{if .Hooks}}
                    <table>
                        <thead>
                            <tr>
                                <th>Bead</th>
                                <th>Title</th>
                                <th>Agent</th>
                                <th>Hooked</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Hooks}}
                            <tr class="{{if .IsStale}}hook-stale{{end}}">
                                <td><span class="hook-id">{{.ID}}</span></td>
                                <td class="hook-title">{{.Title}}</td>
                                <td class="hook-agent">{{.Agent}}</td>
                                <td>
                                    {{if .IsStale}}
                                    <span class="badge badge-yellow">{{.Age}}</span>
                                    {{else}}
                                    {{.Age}}
                                    {{end}}
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                    {{else}}
                    <div class="empty-state">
                        <p>No hooked work</p>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
    </div>

    <!-- Command Palette (outside HTMX-refreshed area) -->
    <div id="command-palette-overlay" class="command-palette-overlay">
        <div class="command-palette">
            <input type="text" id="command-palette-input" class="command-palette-input" placeholder="Search commands..." autocomplete="off">
            <div id="command-palette-results" class="command-palette-results"></div>
            <div class="command-palette-footer">
                <span><kbd>‚Üë‚Üì</kbd> navigate</span>
                <span><kbd>‚Üµ</kbd> execute</span>
                <span><kbd>esc</kbd> close</span>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Output Panel -->
    <div id="output-panel" class="output-panel">
        <div class="output-panel-header">
            <span class="output-panel-title">
                <span>üìã</span>
                <span id="output-panel-cmd">Command Output</span>
            </span>
            <div class="output-panel-actions">
                <button id="output-copy-btn" class="output-panel-btn">Copy</button>
                <button id="output-close-btn" class="output-panel-btn">Close</button>
            </div>
        </div>
        <div id="output-panel-content" class="output-panel-content"></div>
    </div>

    <script src="/static/dashboard.js?v=2"></script>
</body>
</html>
